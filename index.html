<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depot Leave Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ðŸ”´ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ø¢Ø®Ø± Ù†Ø³Ø®Ø©)
        const API_URL = "https://script.google.com/macros/s/AKfycbzqnlL3-wlQFop9WMwEgx1JT7DqD_Ss_56tI_86NF6J54d5I7X0qEFRPdzQDdkOScEHVg/exec";
    </script>

    <style>
        :root { --primary: #2563eb; --primary-dark: #1e40af; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; --sidebar: #1e293b; --card-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg); font-family: 'Poppins', sans-serif; color: #334155; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spinner-large { width: 60px; height: 60px; border: 5px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login */
        #view-login { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 420px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .login-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .login-icon i { font-size: 2rem; color: white; }

        /* Sidebar */
        .sidebar { min-height: 100vh; background: var(--sidebar); color: white; padding: 25px 20px; position: sticky; top: 0; overflow-y: auto; }
        .sidebar-header { padding-bottom: 30px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 20px; }
        .user-info { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin-top: 20px; }
        .nav-link { color: #94a3b8; margin: 5px 0; padding: 12px 15px; border-radius: 10px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-link:hover, .nav-link.active { background: var(--primary); color: white; transform: translateX(5px); }
        
        /* Main Content */
        .main-content { padding: 30px; height: 100vh; overflow-y: auto; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: var(--card-shadow); border-left: 5px solid; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .card-custom { background: white; border-radius: 15px; padding: 30px; box-shadow: var(--card-shadow); margin-bottom: 25px; }
        
        /* Tables & Badges */
        .table-custom { width: 100%; border-collapse: separate; border-spacing: 0; }
        .table-custom th { padding: 15px; border-bottom: 2px solid #e2e8f0; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        .table-custom td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .badge-status { padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .bg-pending { background: #fef3c7; color: #d97706; }
        .bg-approved { background: #dcfce7; color: #166534; }
        .bg-rejected { background: #fee2e2; color: #991b1b; }

        /* Calendar Fixes */
        #calendar { background: white; padding: 20px; border-radius: 15px; }
        .fc-daygrid-day { cursor: pointer; }
        .fc-daygrid-day.fc-day-past { background: #f8fafc; opacity: 0.6; }
        .fc-daygrid-day.day-blocked { background: #fee2e2 !important; cursor: not-allowed; }
        .fc-daygrid-day.day-limited { background: #fef3c7 !important; }
        
        /* Mobile */
        @media (max-width: 768px) { .sidebar { min-height: auto; } .main-content { padding: 20px; } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden"><div class="spinner-large"></div></div>

    <div id="view-login">
        <div class="login-card">
            <div class="login-icon"><i class="fas fa-building"></i></div>
            <h4 class="text-center fw-bold mb-2">Depot Dispatcher Leave Management</h4>
            <p class="text-center text-muted mb-4">Sign in to your account</p>
            <input type="text" id="login-user" class="form-control mb-3" placeholder="Username">
            <input type="password" id="login-pass" class="form-control mb-4" placeholder="Password">
            <button onclick="doLogin()" id="btn-login" class="btn btn-primary w-100 py-2 fw-bold">Login</button>
        </div>
    </div>

    <div id="view-app" class="container-fluid hidden">
        <div class="row">
            <div class="col-md-2 sidebar">
                <div class="sidebar-header">
                    <h5><i class="fas fa-cube me-2"></i> HR Portal</h5>
                    <div class="user-info">
                        <div class="fw-bold" id="u-name">User</div>
                        <small class="text-muted" id="u-role">Role</small>
                        <div id="balance-display" class="mt-2 hidden">
                            <span class="badge bg-success"><i class="fas fa-calendar-check me-1"></i> <span id="u-balance">0</span> days</span>
                        </div>
                    </div>
                </div>
                <nav class="nav flex-column">
                    <a class="nav-link active" onclick="nav('home')"><i class="fas fa-home"></i> Dashboard</a>
                    <div id="menu-emp" class="hidden">
                        <a class="nav-link" onclick="nav('new-req')"><i class="fas fa-plus-circle"></i> New Request</a>
                        <a class="nav-link" onclick="nav('my-req')"><i class="fas fa-history"></i> My Requests</a>
                    </div>
                    <div id="menu-admin" class="hidden">
                        <a class="nav-link" onclick="nav('admin-req')"><i class="fas fa-tasks"></i> Manage Requests</a>
                        <a class="nav-link" onclick="nav('settings')"><i class="fas fa-cog"></i> Settings</a>
                    </div>
                </nav>
                <div class="mt-auto pt-5"><button onclick="location.reload()" class="btn btn-outline-light btn-sm w-100">Logout</button></div>
            </div>

            <div class="col-md-10 main-content">
                <div id="page-home" class="page-section">
                    <h3 class="fw-bold mb-4">Dashboard</h3>
                    
                    <div id="admin-stats" class="row g-4 mb-4 hidden">
                        <div class="col-md-3"><div class="stat-card border-primary"><h2 class="text-primary" id="stat-total">0</h2><small>Total Requests</small></div></div>
                        <div class="col-md-3"><div class="stat-card border-warning"><h2 class="text-warning" id="stat-pending">0</h2><small>Pending</small></div></div>
                        <div class="col-md-3"><div class="stat-card border-success"><h2 class="text-success" id="stat-approved">0</h2><small>Approved</small></div></div>
                        <div class="col-md-3"><div class="stat-card border-danger"><h2 class="text-danger" id="stat-rejected">0</h2><small>Rejected</small></div></div>
                    </div>

                    <div class="card-custom">
                        <div class="alert alert-primary d-flex align-items-center"><i class="fas fa-info-circle me-3"></i> <div><strong>Welcome back!</strong> Check calendar availability before applying.</div></div>
                    </div>

                    <div class="card-custom">
                        <h6 class="mb-3 fw-bold"><i class="fas fa-users me-2"></i> Who's Out Today?</h6>
                        <div id="team-status-container"><small class="text-muted">Loading...</small></div>
                    </div>

                    <div id="emp-quick-stats" class="hidden row g-4 mt-2">
                        <div class="col-md-4"><div class="card-custom text-center"><h4 id="emp-approved" class="text-success">0</h4><small>Approved</small></div></div>
                        <div class="col-md-4"><div class="card-custom text-center"><h4 id="emp-pending" class="text-warning">0</h4><small>Pending</small></div></div>
                        <div class="col-md-4"><div class="card-custom text-center"><h4 id="emp-days-used" class="text-primary">0</h4><small>Days Used</small></div></div>
                    </div>
                </div>

                <div id="page-new-req" class="page-section hidden">
                    <h3 class="fw-bold mb-4">Book a Leave</h3>
                    <div class="card-custom">
                        <div class="alert alert-success mb-3 small"><i class="fas fa-lightbulb me-2"></i> Red dates are full. Click available dates to book.</div>
                        <div id="calendar"></div>
                    </div>
                </div>

                <div id="page-my-req" class="page-section hidden">
                    <h3 class="fw-bold mb-4">My Requests</h3>
                    <div class="card-custom"><table class="table-custom"><thead class="bg-light"><tr><th>Date</th><th>Type</th><th>Period</th><th>Days</th><th>Status</th><th>Notes</th></tr></thead><tbody id="tb-my-req"></tbody></table></div>
                </div>

                <div id="page-admin-req" class="page-section hidden">
                    <h3 class="fw-bold mb-4">Manage Requests</h3>
                    <div class="card-custom"><table class="table-custom"><thead><tr><th>Employee</th><th>Type</th><th>Period</th><th>Days</th><th>Status</th><th>Action</th></tr></thead><tbody id="tb-admin-req"></tbody></table></div>
                </div>

                <div id="page-settings" class="page-section hidden">
                    <h3 class="fw-bold mb-4">Settings</h3>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card-custom border-primary border">
                                <label class="small fw-bold text-primary mb-2">Default Daily Limit</label>
                                <div class="input-group"><input type="number" id="default-limit" class="form-control"><button onclick="updateDefault()" class="btn btn-primary">Update</button></div>
                            </div>
                            <div class="card-custom mt-3">
                                <h6 class="fw-bold mb-3">Add Seasonal Rule</h6>
                                <input type="date" id="s-start" class="form-control mb-2"><input type="date" id="s-end" class="form-control mb-2">
                                <input type="number" id="s-limit" class="form-control mb-2" placeholder="Limit">
                                <button onclick="saveSeason()" class="btn btn-dark w-100">Add Rule</button>
                            </div>
                        </div>
                        <div class="col-md-8"><div class="card-custom"><table class="table-custom"><thead><tr><th>Start</th><th>End</th><th>Limit</th><th>Action</th></tr></thead><tbody id="tb-settings"></tbody></table></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reqModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Request Leave</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Duration</label>
                        <select id="m-duration" class="form-select" onchange="calculateDaysLogic()">
                            <option value="Full">Full Day</option>
                            <option value="Half">Half Day (0.5)</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3"><label class="small fw-bold">Start</label><input type="date" id="m-start" class="form-control" readonly></div>
                        <div class="col-6 mb-3"><label class="small fw-bold">End</label><input type="date" id="m-end" class="form-control"></div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Type</label>
                        <select id="m-type" class="form-select">
                            <option>Annual</option><option>Sick</option><option>Maternity</option><option>Paternity</option><option>Unpaid</option>
                        </select>
                    </div>
                    <textarea id="m-notes" class="form-control mb-3" placeholder="Notes..."></textarea>
                    <div class="alert alert-info py-2 small">Duration: <strong id="req-days">1</strong> days | Balance: <strong id="req-balance">0</strong></div>
                </div>
                <div class="modal-footer"><button onclick="sendReq()" class="btn btn-primary w-100">Submit</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminActionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Review</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><div id="admin-action-info" class="alert alert-secondary"></div><textarea id="admin-notes" class="form-control" placeholder="Admin notes..."></textarea></div>
            <div class="modal-footer"><button onclick="confirmAdminAction('Rejected')" class="btn btn-danger">Reject</button><button onclick="confirmAdminAction('Approved')" class="btn btn-success">Approve</button></div>
        </div></div>
    </div>

    <script>
        // --- LOGIC STARTS HERE ---
        let DATA = { user: {}, settings: [], approvedRequests: [], myRequests: [], teamLeaves: [] };
        let calendarObj = null;
        let currentAdminRequestId = null;

        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }

        async function apiCall(payload) {
            try {
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                if (!res.ok) throw new Error(res.status);
                return await res.json();
            } catch (e) { console.error(e); throw e; }
        }

        async function doLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if (!u || !p) { Swal.fire('Error', 'Required fields', 'error'); return; }
            
            const btn = document.getElementById('btn-login'); btn.innerHTML = 'Loading...'; btn.disabled = true;

            try {
                const res = await apiCall({ action: 'login', username: u, password: p });
                if (res.success) {
                    DATA = res;
                    DATA.settings = DATA.settings || [];
                    DATA.approvedRequests = DATA.approvedRequests || [];
                    DATA.teamLeaves = DATA.teamLeaves || [];
                    initApp();
                } else { Swal.fire('Failed', res.message, 'error'); btn.innerHTML = 'Login'; btn.disabled = false; }
            } catch (e) { Swal.fire('Connection Error', 'Check API URL', 'error'); btn.innerHTML = 'Login'; btn.disabled = false; }
        }

        function initApp() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('u-name').textContent = DATA.user.name || 'User';
            document.getElementById('u-role').textContent = DATA.user.role || 'Employee';

            if (DATA.user.role === 'Admin') {
                document.getElementById('menu-admin').classList.remove('hidden');
                document.getElementById('admin-stats').classList.remove('hidden');
                updateDashboard(); renderSettings();
            } else {
                document.getElementById('menu-emp').classList.remove('hidden');
                document.getElementById('balance-display').classList.remove('hidden');
                document.getElementById('u-balance').textContent = DATA.user.balance;
                document.getElementById('emp-quick-stats').classList.remove('hidden');
                updateEmployeeStats();
            }
            renderMyRequests();
            updateTeamView();
            initCalendar();
            nav('home');
        }

        function nav(id) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(event) event.target.closest('.nav-link').classList.add('active');

            if(id === 'new-req' && calendarObj) {
                setTimeout(() => { calendarObj.updateSize(); }, 200); // ðŸ”´ FIX: Calendar render
            }
            if(id === 'admin-req') renderAdminRequests();
        }

        function initCalendar() {
            const el = document.getElementById('calendar');
            if(!el) return;
            calendarObj = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth', height: 500,
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
                dayCellClassNames: (arg) => {
                    const today = new Date(); today.setHours(0,0,0,0);
                    if(arg.date < today) return ['fc-day-past'];
                    const d = arg.date.toISOString().split('T')[0];
                    const lim = getDailyLimit(d);
                    const cnt = getApprovedCount(d);
                    if(lim === 0 || cnt >= lim) return ['day-blocked'];
                    if(cnt >= lim - 1) return ['day-limited'];
                    return [];
                },
                dateClick: (info) => {
                    const today = new Date(); today.setHours(0,0,0,0);
                    if(new Date(info.dateStr) < today) { Swal.fire('','Past date','warning'); return; }
                    const d = info.dateStr;
                    if(getDailyLimit(d)===0 || getApprovedCount(d)>=getDailyLimit(d)) { Swal.fire('','Full','warning'); return; }
                    openRequestModal(d);
                }
            });
            calendarObj.render();
        }

        function getDailyLimit(dStr) {
            const d = new Date(dStr);
            const sets = DATA.settings || [];
            const sea = sets.filter(s => s.type === 'Season');
            for(let r of sea) if(d >= new Date(r.start) && d <= new Date(r.end)) return r.limit;
            const def = sets.find(s => s.type === 'Default');
            return def ? def.limit : 2;
        }

        function getApprovedCount(dStr) {
            const d = new Date(dStr);
            return (DATA.approvedRequests||[]).filter(r => d >= new Date(r.start) && d <= new Date(r.end)).length;
        }

        function openRequestModal(d) {
            document.getElementById('m-start').value = d;
            document.getElementById('m-end').value = d;
            document.getElementById('m-notes').value = '';
            document.getElementById('m-duration').value = 'Full';
            calculateDaysLogic();
            document.getElementById('m-end').onchange = calculateDaysLogic;
            new bootstrap.Modal(document.getElementById('reqModal')).show();
        }

        function calculateDaysLogic() {
            const s = document.getElementById('m-start').value;
            const e = document.getElementById('m-end').value;
            const dur = document.getElementById('m-duration').value;
            if(s && e) {
                if(dur === 'Half') {
                    if(s !== e) document.getElementById('m-end').value = s;
                    document.getElementById('req-days').textContent = "0.5";
                } else {
                    const d1 = new Date(s); const d2 = new Date(e);
                    const diff = Math.abs(d2 - d1);
                    document.getElementById('req-days').textContent = Math.ceil(diff/(1000*60*60*24)) + 1;
                }
                document.getElementById('req-balance').textContent = DATA.user.balance;
            }
        }

        async function sendReq() {
            const start = document.getElementById('m-start').value;
            const end = document.getElementById('m-end').value;
            const type = document.getElementById('m-type').value;
            const notes = document.getElementById('m-notes').value;
            const days = parseFloat(document.getElementById('req-days').textContent);
            
            if(new Date(end) < new Date(start)) { Swal.fire('Error','Invalid dates','error'); return; }
            
            showLoading();
            bootstrap.Modal.getInstance(document.getElementById('reqModal')).hide();
            try {
                const res = await apiCall({ action: 'submitRequest', form: { username: DATA.user.username, name: DATA.user.name, start, end, days, type, notes } });
                if(res.success) { Swal.fire('Success','Sent','success'); await refreshData(); }
                else Swal.fire('Error', res.message, 'error');
            } catch(e) { Swal.fire('Error','Failed','error'); }
            finally { hideLoading(); }
        }

        function updateDashboard() {
            const r = DATA.allRequests || [];
            document.getElementById('stat-total').textContent = r.length;
            document.getElementById('stat-pending').textContent = r.filter(x => x.status === 'Pending').length;
            document.getElementById('stat-approved').textContent = r.filter(x => x.status === 'Approved').length;
            document.getElementById('stat-rejected').textContent = r.filter(x => x.status === 'Rejected').length;
        }

        function updateEmployeeStats() {
            const m = DATA.myRequests || [];
            document.getElementById('emp-approved').textContent = m.filter(x => x.status === 'Approved').length;
            document.getElementById('emp-pending').textContent = m.filter(x => x.status === 'Pending').length;
            const used = m.filter(x => x.status === 'Approved' && x.type === 'Annual').reduce((a,b) => a + (Number(b.days)||0), 0);
            document.getElementById('emp-days-used').textContent = used;
        }

        function updateTeamView() {
            const l = DATA.teamLeaves || [];
            const t = new Date().toISOString().split('T')[0];
            const c = document.getElementById('team-status-container');
            const abs = l.filter(x => t >= x.start && t <= x.end);
            
            if(abs.length === 0) c.innerHTML = '<div class="alert alert-success py-2 mb-0"><i class="fas fa-check-circle me-2"></i> All Present</div>';
            else c.innerHTML = abs.map(p => `<div class="d-flex align-items-center border-bottom py-2"><div class="bg-danger text-white rounded-circle d-flex justify-content-center align-items-center me-3" style="width:35px;height:35px">${p.name.charAt(0)}</div><div><div class="fw-bold small">${p.name}</div><small class="text-muted">${p.type} until ${p.end}</small></div></div>`).join('');
        }

        function renderMyRequests() {
            const r = DATA.myRequests || [];
            document.getElementById('tb-my-req').innerHTML = r.length ? r.map(x => `<tr><td>${new Date(Number(x.id)).toLocaleDateString()}</td><td>${x.type}</td><td>${x.start} -> ${x.end}</td><td>${x.days}</td><td><span class="badge-status bg-${x.status.toLowerCase()}">${x.status}</span></td><td>${x.notes||''}</td></tr>`).join('') : '<tr><td colspan="6" class="text-center text-muted">No requests</td></tr>';
        }

        function renderAdminRequests() {
            const r = DATA.allRequests || [];
            document.getElementById('tb-admin-req').innerHTML = r.length ? r.map(x => `<tr><td><b>${x.name}</b><br><small>${x.username}</small></td><td>${x.type}</td><td>${x.start} -> ${x.end}</td><td>${x.days}</td><td><span class="badge-status bg-${x.status.toLowerCase()}">${x.status}</span></td><td>${x.status==='Pending' ? `<button onclick="openAdminAction('${x.id}','${x.name}','${x.start}','${x.end}','${x.days}')" class="btn btn-sm btn-primary">Review</button>` : '-'}</td></tr>`).join('') : '<tr><td colspan="6" class="text-center text-muted">No requests</td></tr>';
        }

        function openAdminAction(id, name, s, e, d) {
            currentAdminRequestId = id;
            document.getElementById('admin-action-info').innerHTML = `<b>${name}</b><br>${s} to ${e} (${d} days)`;
            new bootstrap.Modal(document.getElementById('adminActionModal')).show();
        }

        async function confirmAdminAction(act) {
            if(!currentAdminRequestId) return;
            showLoading();
            bootstrap.Modal.getInstance(document.getElementById('adminActionModal')).hide();
            try {
                await apiCall({ action: 'adminAction', id: currentAdminRequestId, act, notes: document.getElementById('admin-notes').value });
                Swal.fire('Done','','success'); await refreshData();
            } catch(e) { Swal.fire('Error','Failed','error'); } finally { hideLoading(); }
        }

        function renderSettings() {
            const s = (DATA.settings||[]).filter(x => x.type === 'Season');
            const d = (DATA.settings||[]).find(x => x.type === 'Default');
            if(d) document.getElementById('default-limit').value = d.limit;
            document.getElementById('tb-settings').innerHTML = s.map((x,i) => `<tr><td>${x.start}</td><td>${x.end}</td><td>${x.limit}</td><td><button onclick="delRule(${i})" class="btn btn-sm btn-danger">Del</button></td></tr>`).join('');
        }

        async function updateDefault() { showLoading(); await apiCall({action:'updateDefault', limit: document.getElementById('default-limit').value}); await refreshData(); hideLoading(); }
        async function saveSeason() { showLoading(); await apiCall({action:'saveSeason', start: document.getElementById('s-start').value, end: document.getElementById('s-end').value, limit: document.getElementById('s-limit').value}); await refreshData(); hideLoading(); }
        async function delRule(i) { if(confirm('Delete?')) { showLoading(); await apiCall({action:'deleteSetting', index: i}); await refreshData(); hideLoading(); } }

        async function refreshData() {
            const res = await apiCall({ action: 'login', username: DATA.user.username, password: 'refresh' });
            if(res.success) { DATA = res; initApp(); }
        }
    </script>
</body>
</html>
