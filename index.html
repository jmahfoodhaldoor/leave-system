<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ðŸ”´ðŸ”´ðŸ”´ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø±Ù‡ Ø¨ØµÙ„Ø§Ø­ÙŠØ© ANYONE ðŸ”´ðŸ”´ðŸ”´
        const API_URL = "https://script.google.com/macros/s/AKfycbyxS6ECeugLmbHcJDbOXg4SR32WPVD_enwB5wtm-E47EZxEJezPL8K7QIVlpKx3VnK2YQ/exec";
    </script>

    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --sidebar: #1e293b; }
        body { background-color: var(--bg); font-family: 'Poppins', sans-serif; color: #334155; }
        .hidden { display: none !important; }
        .sidebar { min-height: 100vh; background-color: var(--sidebar); color: white; padding: 20px; }
        .nav-link { color: #94a3b8; margin: 8px 0; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: #334155; color: white; padding-left: 15px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-custom { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .badge-status { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .bg-pending { background: #fef3c7; color: #d97706; }
        .bg-approved { background: #dcfce7; color: #166534; }
        .bg-rejected { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <div id="view-login" class="d-flex align-items-center justify-content-center vh-100 bg-white">
        <div class="card p-5 border-0 shadow-lg" style="width: 400px;">
            <div class="text-center mb-4"><i class="fas fa-fingerprint fa-3x text-primary"></i><h4 class="mt-3 fw-bold">Admin Portal</h4></div>
            <input type="text" id="login-user" class="form-control mb-3" placeholder="Username">
            <input type="password" id="login-pass" class="form-control mb-4" placeholder="Password">
            <button onclick="doLogin()" id="btn-login" class="btn btn-primary w-100">Login</button>
        </div>
    </div>

    <div id="view-app" class="container-fluid hidden">
        <div class="row">
            <div class="col-md-2 sidebar">
                <h5 class="fw-bold mb-5"><i class="fas fa-cube me-2"></i> HR System</h5>
                <nav class="nav flex-column">
                    <a class="nav-link active" onclick="nav('home')"><i class="fas fa-chart-pie me-2"></i> Dashboard</a>
                    <div id="menu-emp" class="hidden">
                        <a class="nav-link" onclick="nav('new-req')"><i class="fas fa-plus-circle me-2"></i> New Request</a>
                        <a class="nav-link" onclick="nav('my-req')"><i class="fas fa-history me-2"></i> My History</a>
                    </div>
                    <div id="menu-admin" class="hidden">
                        <a class="nav-link" onclick="nav('admin-req')"><i class="fas fa-tasks me-2"></i> Requests</a>
                        <a class="nav-link" onclick="nav('settings')"><i class="fas fa-sliders-h me-2"></i> Settings & Rules</a>
                    </div>
                </nav>
                <div class="mt-auto pt-5"><button onclick="location.reload()" class="btn btn-outline-secondary btn-sm w-100">Logout</button></div>
            </div>

            <div class="col-md-10 p-4" style="height: 100vh; overflow-y: auto;">
                
                <div id="page-home" class="page-section">
                    <h3 class="fw-bold mb-4">Dashboard</h3>
                    <div id="admin-stats" class="row g-3 mb-4 hidden">
                        <div class="col-md-3"><div class="stat-card border-primary"><h2 class="fw-bold mb-0" id="stat-total">0</h2><small class="text-muted">Total Requests</small></div></div>
                        <div class="col-md-3"><div class="stat-card border-warning" style="border-color:#f59e0b!important"><h2 class="fw-bold mb-0" id="stat-pending">0</h2><small class="text-muted">Pending</small></div></div>
                        <div class="col-md-3"><div class="stat-card border-success" style="border-color:#10b981!important"><h2 class="fw-bold mb-0" id="stat-approved">0</h2><small class="text-muted">Approved</small></div></div>
                        <div class="col-md-3"><div class="stat-card border-danger" style="border-color:#ef4444!important"><h2 class="fw-bold mb-0" id="stat-rejected">0</h2><small class="text-muted">Rejected</small></div></div>
                    </div>
                    <div class="card-custom"><h5>ðŸ‘‹ Welcome back!</h5><p class="text-muted">Check the calendar availability before submitting new requests.</p></div>
                </div>

                <div id="page-new-req" class="page-section hidden">
                    <h3 class="fw-bold mb-4">Book a Leave</h3>
                    <div class="card-custom"><div id="calendar"></div></div>
                </div>

                <div id="page-my-req" class="page-section hidden">
                    <h3 class="fw-bold mb-4">My History</h3>
                    <div class="card-custom"><table class="table"><tbody id="tb-my-req"></tbody></table></div>
                </div>

                <div id="page-admin-req" class="page-section hidden">
                    <h3 class="fw-bold mb-4">Manage Requests</h3>
                    <div class="card-custom"><table class="table align-middle"><thead><tr><th>Employee</th><th>Dates</th><th>Status</th><th>Actions</th></tr></thead><tbody id="tb-admin-req"></tbody></table></div>
                </div>

                <div id="page-settings" class="page-section hidden">
                    <h3 class="fw-bold mb-4">System Rules</h3>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card-custom border-primary border">
                                <h6 class="text-primary mb-3">Default Daily Limit</h6>
                                <div class="input-group"><input type="number" id="default-limit" class="form-control" placeholder="2"><button onclick="updateDefault()" class="btn btn-primary">Update</button></div>
                            </div>
                            <div class="card-custom">
                                <h6>Add New Season</h6>
                                <input type="date" id="s-start" class="form-control mb-2"><input type="date" id="s-end" class="form-control mb-2">
                                <input type="number" id="s-limit" class="form-control mb-2" placeholder="Limit (0=Block)">
                                <button onclick="saveSeason()" class="btn btn-dark w-100">Add Rule</button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card-custom">
                                <h6>Active Rules</h6>
                                <table class="table"><thead><tr><th>Start</th><th>End</th><th>Limit</th><th>Action</th></tr></thead><tbody id="tb-settings"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="reqModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirm</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="m-start" class="form-control mb-2" readonly><input type="date" id="m-end" class="form-control mb-2"><select id="m-type" class="form-select"><option>Annual</option><option>Sick</option></select></div><div class="modal-footer"><button onclick="sendReq()" class="btn btn-primary w-100">Submit</button></div></div></div></div>

    <script>
        let DATA = {}; let calendarObj = null;

        async function apiCall(payload) {
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
            return await res.json();
        }

        async function doLogin() {
            const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value;
            const btn = document.getElementById('btn-login'); btn.innerText = "Loading..."; btn.disabled = true;
            try {
                const res = await apiCall({ action: 'login', username: u, password: p });
                if(res.success) { DATA = res; initApp(); } else { Swal.fire('Error', res.message, 'error'); }
            } catch(e) { Swal.fire('Connection Failed', 'Check URL or Permissions', 'error'); }
            btn.innerText = "Login"; btn.disabled = false;
        }

        function initApp() {
            document.getElementById('view-login').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('u-name').innerText = DATA.user.name || 'User';
            
            if(DATA.user.role === 'Admin') {
                document.getElementById('menu-admin').classList.remove('hidden');
                document.getElementById('admin-stats').classList.remove('hidden');
                updateDash(); renderSettings();
            } else { document.getElementById('menu-emp').classList.remove('hidden'); }
            
            renderMy(); initCalendar(); nav('home');
        }

        function nav(id) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('page-'+id).classList.remove('hidden');
            if(id === 'new-req' && calendarObj) setTimeout(() => calendarObj.render(), 200);
        }

        function updateDash() {
            const r = DATA.allRequests || [];
            document.getElementById('stat-total').innerText = r.length;
            document.getElementById('stat-pending').innerText = r.filter(x => x.status === 'Pending').length;
            document.getElementById('stat-approved').innerText = r.filter(x => x.status === 'Approved').length;
            document.getElementById('stat-rejected').innerText = r.filter(x => x.status === 'Rejected').length;
            
            const tbody = document.getElementById('tb-admin-req');
            tbody.innerHTML = r.map(x => `<tr><td>${x.name}</td><td>${x.start}</td><td><span class="badge-status bg-${x.status.toLowerCase()}">${x.status}</span></td>
            <td>${x.status==='Pending' ? `<button onclick="admAct('${x.id}','Approved')" class="btn btn-sm btn-success">âœ”</button> <button onclick="admAct('${x.id}','Rejected')" class="btn btn-sm btn-danger">âœ˜</button>`:''}</td></tr>`).join('');
        }

        function renderSettings() {
            const def = DATA.settings.find(s => s.type === 'Default');
            if(def) document.getElementById('default-limit').value = def.limit;
            
            const seasons = DATA.settings.filter(s => s.type === 'Season');
            document.getElementById('tb-settings').innerHTML = seasons.map((s, i) => `
                <tr><td>${s.start}</td><td>${s.end}</td><td>${s.limit}</td>
                <td><button onclick="delRule(${i})" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }

        async function updateDefault() {
            await apiCall({ action: 'updateDefault', limit: document.getElementById('default-limit').value });
            Swal.fire('Updated', '', 'success');
        }

        async function saveSeason() {
            await apiCall({ action: 'saveSeason', start: document.getElementById('s-start').value, end: document.getElementById('s-end').value, limit: document.getElementById('s-limit').value });
            Swal.fire('Saved', 'Refresh to see changes', 'success');
        }

        async function delRule(idx) {
            if(confirm('Delete rule?')) { await apiCall({ action: 'deleteSetting', index: idx }); Swal.fire('Deleted', 'Refresh to see changes', 'success'); }
        }

        function initCalendar() {
            calendarObj = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', height: 500,
                dayCellClassNames: (arg) => {
                    if (arg.date < new Date().setHours(0,0,0,0)) return [];
                    const d = arg.date.toISOString().split('T')[0];
                    const lim = getLim(d); const cnt = getCnt(d);
                    return (lim === 0 || cnt >= lim) ? ['bg-danger','bg-opacity-10'] : [];
                },
                dateClick: (info) => {
                    const d = info.dateStr; if(getLim(d)===0 || getCnt(d)>=getLim(d)) return Swal.fire('Full','','warning');
                    document.getElementById('m-start').value = d; document.getElementById('m-end').value = d;
                    new bootstrap.Modal(document.getElementById('reqModal')).show();
                }
            });
            calendarObj.render();
        }

        function getLim(d) {
            let dt = new Date(d);
            let s = DATA.settings.find(x => x.type==='Season' && dt>=new Date(x.start) && dt<=new Date(x.end));
            if(s) return s.limit;
            let def = DATA.settings.find(x => x.type==='Default'); return def ? def.limit : 2;
        }
        function getCnt(d) { let t=new Date(d); return DATA.approvedRequests.filter(r => t>=new Date(r.start) && t<=new Date(r.end)).length; }
        
        async function sendReq() {
            await apiCall({ action: 'submitRequest', form: { username: DATA.user.username, name: DATA.user.name, start: document.getElementById('m-start').value, end: document.getElementById('m-end').value, type: document.getElementById('m-type').value } });
            bootstrap.Modal.getInstance(document.getElementById('reqModal')).hide(); Swal.fire('Sent','','success');
        }
        
        async function admAct(id, act) { await apiCall({ action: 'adminAction', id: id, act: act }); Swal.fire('Done','','success'); }
        function renderMy() { document.getElementById('tb-my-req').innerHTML = (DATA.myRequests||[]).map(r => `<tr><td>${r.start}</td><td>${r.type}</td><td>${r.status}</td></tr>`).join(''); }
    </script>
</body>
</html>
