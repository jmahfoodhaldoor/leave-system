<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depot Dispatcher Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ðŸ”´ðŸ”´ðŸ”´ Ù‡Ø§Ù…: Ø¶Ø¹ Ø±Ø§Ø¨Ø· Google Apps Script Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ ðŸ”´ðŸ”´ðŸ”´
        const API_URL = "https://script.google.com/macros/s/AKfycbzqnlL3-wlQFop9WMwEgx1JT7DqD_Ss_56tI_86NF6J54d5I7X0qEFRPdzQDdkOScEHVg/exec";
    </script>

    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --bg: #f1f5f9; --sidebar-width: 260px; }
        body { background-color: var(--bg); font-family: 'Poppins', sans-serif; color: #334155; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* Loader */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .loading-text { margin-top: 15px; color: var(--primary); font-weight: 500; }
        
        /* Layout */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; background: var(--primary); color: white; padding: 20px; transition: 0.3s; z-index: 1000; overflow-y: auto; }
        .main-content { margin-left: var(--sidebar-width); padding: 30px; min-height: 100vh; }
        
        /* Components */
        .nav-link { color: #94a3b8; padding: 12px 15px; margin: 5px 0; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; transform: translateX(5px); }
        .card-custom { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e2e8f0; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .badge-status { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .bg-pending { background: #fef3c7; color: #92400e; }
        .bg-approved { background: #d1fae5; color: #065f46; }
        .bg-rejected { background: #fee2e2; color: #991b1b; }
        
        /* Calendar Fixes */
        .fc-daygrid-day { cursor: pointer; transition: 0.2s; }
        .fc-daygrid-day:hover { background-color: #f1f5f9; }
        .fc .fc-button-primary { background: var(--primary); border-color: var(--primary); }
        
        /* Status Colors */
        .day-blocked { background-color: #fee2e2 !important; color: #b91c1c !important; cursor: not-allowed !important; }
        .day-limited { background-color: #fef3c7 !important; }
        .day-past { background-color: #f8fafc !important; opacity: 0.6; cursor: not-allowed !important; }

        /* Login */
        #view-login { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

        @media (max-width: 768px) {
            .sidebar { left: -100%; }
            .sidebar.active { left: 0; }
            .main-content { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <div id="view-login">
        <div class="login-box">
            <div class="text-center mb-4">
                <i class="fas fa-cubes fa-3x text-primary mb-3"></i>
                <h4 class="fw-bold">Depot Dispatcher</h4>
                <p class="text-muted small">Employee Leave Portal</p>
            </div>
            <form onsubmit="event.preventDefault(); doLogin();">
                <div class="mb-3">
                    <label class="small fw-bold">Username</label>
                    <input type="text" id="login-user" class="form-control" required>
                </div>
                <div class="mb-4">
                    <label class="small fw-bold">Password</label>
                    <input type="password" id="login-pass" class="form-control" required>
                </div>
                <button type="submit" id="btn-login" class="btn btn-primary w-100 py-2">Sign In</button>
            </form>
        </div>
    </div>

    <div id="view-app" class="hidden">
        <div class="sidebar">
            <h5 class="mb-4 fw-bold"><i class="fas fa-cubes me-2"></i> Depot Portal</h5>
            <div class="mb-4 p-3 rounded bg-white bg-opacity-10">
                <div class="fw-bold" id="u-name">User</div>
                <small class="text-white-50" id="u-role">Role</small>
                <div id="balance-badge" class="mt-2 hidden">
                    <span class="badge bg-success">
                        <i class="fas fa-calendar-check me-1"></i>
                        <span id="u-balance">0</span> Days
                    </span>
                </div>
            </div>
            <nav>
                <div class="nav-link active" onclick="nav('home')">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div id="menu-emp" class="hidden">
                    <div class="nav-link" onclick="nav('new-req')">
                        <i class="fas fa-plus-circle"></i> New Request
                    </div>
                    <div class="nav-link" onclick="nav('my-req')">
                        <i class="fas fa-history"></i> My History
                    </div>
                    <div class="nav-link" onclick="openChangePassword()">
                        <i class="fas fa-key"></i> Change Password
                    </div>
                </div>
                <div id="menu-admin" class="hidden">
                    <div class="nav-link" onclick="nav('admin-req')">
                        <i class="fas fa-tasks"></i> Requests 
                        <span id="badge-pending" class="badge bg-danger ms-auto hidden">0</span>
                    </div>
                    <div class="nav-link" onclick="nav('employees')">
                        <i class="fas fa-users"></i> Employees
                    </div>
                    <div class="nav-link" onclick="nav('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                </div>
            </nav>
            <div class="mt-auto position-absolute bottom-0 start-0 p-3 w-100">
                <button onclick="location.reload()" class="btn btn-outline-light w-100 btn-sm">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Dashboard -->
            <div id="page-home" class="page-section">
                <h3 class="fw-bold mb-4">Dashboard</h3>
                
                <!-- Admin Stats -->
                <div id="admin-stats" class="row g-4 mb-4 hidden">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h2 class="fw-bold mb-1" id="st-total">0</h2>
                            <small class="text-muted">Total Requests</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="border-left-color: #f59e0b">
                            <h2 class="fw-bold mb-1" id="st-pending">0</h2>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="border-left-color: #10b981">
                            <h2 class="fw-bold mb-1" id="st-approved">0</h2>
                            <small class="text-muted">Approved</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="border-left-color: #ef4444">
                            <h2 class="fw-bold mb-1" id="st-rejected">0</h2>
                            <small class="text-muted">Rejected</small>
                        </div>
                    </div>
                </div>

                <!-- Team Status -->
                <div class="card-custom">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-calendar-day me-2 text-primary"></i> 
                        Who's Out Today?
                    </h6>
                    <div id="team-view-container" class="d-flex flex-wrap gap-2">
                        <small class="text-muted">Loading...</small>
                    </div>
                </div>
            </div>

            <!-- New Request -->
            <div id="page-new-req" class="page-section hidden">
                <h3 class="fw-bold mb-4">New Request</h3>
                <div class="row">
                    <div class="col-md-8">
                        <div class="card-custom">
                            <div class="alert alert-info small mb-3">
                                <i class="fas fa-info-circle me-2"></i> 
                                <strong>Legend:</strong> Red = Full | Yellow = Limited | Green = Available
                            </div>
                            <div id="calendar"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-custom bg-primary text-white">
                            <h5 class="mb-3">Your Balance</h5>
                            <h2 class="display-4 fw-bold mb-0" id="disp-balance">0</h2>
                            <small>Days Available</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Requests -->
            <div id="page-my-req" class="page-section hidden">
                <h3 class="fw-bold mb-4">My History</h3>
                <div class="card-custom">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Period</th>
                                    <th>Days</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th>Attachment</th>
                                </tr>
                            </thead>
                            <tbody id="tb-my-req"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Requests -->
            <div id="page-admin-req" class="page-section hidden">
                <h3 class="fw-bold mb-4">Manage Requests</h3>
                <div class="card-custom">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Employee</th>
                                    <th>Type</th>
                                    <th>Period</th>
                                    <th>Days</th>
                                    <th>Status</th>
                                    <th>Attachment</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tb-admin-req"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Employees -->
            <div id="page-employees" class="page-section hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold">Employees</h3>
                    <button onclick="openAddEmpModal()" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Add Employee
                    </button>
                </div>
                <div class="card-custom">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Email</th>
                                    <th>Balance</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tb-employees"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div id="page-settings" class="page-section hidden">
                <h3 class="fw-bold mb-4">Settings</h3>
                
                <!-- Default Limit Card -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card-custom border-primary" style="border-width: 2px;">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="fw-bold mb-2 text-primary">
                                        <i class="fas fa-sliders-h me-2"></i>
                                        Default Daily Limit
                                    </h6>
                                    <p class="small text-muted mb-0">
                                        Maximum number of employees on leave per day (applies outside seasonal rules)
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="number" id="default-limit" class="form-control" placeholder="e.g., 2" min="0" step="1">
                                        <button onclick="updateDefaultLimit()" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mt-2 text-center">
                                        Current: <strong id="current-default" class="text-primary">-</strong>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seasonal Rules Section -->
                <div class="row">
                    <div class="col-md-5">
                        <div class="card-custom">
                            <h6 class="fw-bold mb-3">Add Seasonal Rule</h6>
                            <p class="small text-muted mb-3">Override the default limit for specific date ranges</p>
                            <label class="small fw-bold">Start Date</label>
                            <input type="date" id="s-start" class="form-control mb-2">
                            <label class="small fw-bold">End Date</label>
                            <input type="date" id="s-end" class="form-control mb-2">
                            <label class="small fw-bold">Daily Limit (0 = Block All)</label>
                            <input type="number" id="s-limit" class="form-control mb-3" placeholder="e.g., 0" min="0">
                            <button onclick="saveSeason()" class="btn btn-dark w-100">
                                <i class="fas fa-plus me-2"></i> Add Rule
                            </button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card-custom">
                            <h6 class="fw-bold mb-3">Active Seasonal Rules</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Start</th>
                                            <th>End</th>
                                            <th>Limit</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tb-settings"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal fade" id="reqModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Submit Leave Request</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="small fw-bold">Duration</label>
                        <select id="m-duration" class="form-select" onchange="calcDays()">
                            <option value="Full">Full Day</option>
                            <option value="Half">Half Day (0.5)</option>
                        </select>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col">
                            <label class="small fw-bold">Start Date</label>
                            <input type="date" id="m-start" class="form-control" readonly>
                        </div>
                        <div class="col">
                            <label class="small fw-bold">End Date</label>
                            <input type="date" id="m-end" class="form-control" onchange="calcDays()">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Leave Type</label>
                        <select id="m-type" class="form-select">
                            <option value="Annual">Annual Leave</option>
                            <option value="Sick">Sick Leave</option>
                            <option value="Medical">Medical Leave</option>
                            <option value="Maternity">Maternity Leave</option>
                            <option value="Paternity">Paternity Leave</option>
                            <option value="Unpaid">Unpaid Leave</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Attachment (Optional)</label>
                        <input type="file" id="m-file" class="form-control" accept="image/*,.pdf">
                        <small class="text-muted">Max 5MB - PDF, JPG, PNG</small>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Notes (Optional)</label>
                        <textarea id="m-notes" class="form-control" rows="2" placeholder="Add any additional information..."></textarea>
                    </div>
                    <div class="alert alert-secondary py-2 d-flex justify-content-between mb-0">
                        <span>Days: <strong id="req-days">0</strong></span>
                        <span>Balance: <strong id="req-bal">0</strong></span>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button onclick="sendReq()" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i> Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal fade" id="empModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Add Employee</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="e-name" class="form-control mb-2" placeholder="Full Name" required>
                    <input type="text" id="e-user" class="form-control mb-2" placeholder="Username (ID)" required>
                    <input type="password" id="e-pass" class="form-control mb-2" placeholder="Password" required>
                    <input type="email" id="e-mail" class="form-control mb-2" placeholder="Email" required>
                    <select id="e-role" class="form-select mb-2">
                        <option value="Employee">Employee</option>
                        <option value="Admin">Admin</option>
                    </select>
                    <input type="number" id="e-bal" class="form-control mb-2" placeholder="Initial Balance (e.g., 20)" value="20">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button onclick="addEmployee()" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Balance Modal -->
    <div class="modal fade" id="balModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Update Balance</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="eb-user">
                    <label class="small fw-bold">New Balance</label>
                    <input type="number" id="eb-val" class="form-control" step="0.5" min="0">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button onclick="saveBalance()" class="btn btn-success">
                        <i class="fas fa-check me-2"></i> Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="passModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Change Password</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="small fw-bold">Current Password</label>
                        <input type="password" id="old-pass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">New Password</label>
                        <input type="password" id="new-pass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Confirm New Password</label>
                        <input type="password" id="confirm-pass" class="form-control">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button onclick="changePassword()" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let DATA = { user: {}, settings: [], approvedRequests: [], myRequests: [], teamLeaves: [] };
        let calendarObj = null;

        function showLoading(text) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            if (text) document.querySelector('.loading-text').textContent = text;
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        async function apiCall(payload) {
            try {
                const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (e) { 
                console.error('API Error:', e); 
                throw e; 
            }
        }

        async function doLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if(!u || !p) return Swal.fire('Error', 'Please enter username and password', 'error');
            
            showLoading('Signing in...');
            try {
                const res = await apiCall({ action: 'login', username: u, password: p });
                if (res.success) { 
                    DATA = res; 
                    DATA.settings = DATA.settings || []; 
                    DATA.approvedRequests = DATA.approvedRequests || []; 
                    DATA.teamLeaves = DATA.teamLeaves || [];
                    initApp(); 
                } else { 
                    Swal.fire('Login Failed', res.message, 'error'); 
                }
            } catch (e) { 
                Swal.fire('Connection Error', 'Could not connect to server. Check API URL.', 'error'); 
            }
            hideLoading();
        }

        function initApp() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            
            const u = DATA.user;
            document.getElementById('u-name').textContent = u.name || 'User';
            document.getElementById('u-role').textContent = u.role || 'Employee';
            document.getElementById('u-balance').textContent = u.balance || 0;
            document.getElementById('disp-balance').textContent = u.balance || 0;
            
            if (u.role === 'Admin') {
                document.getElementById('menu-admin').classList.remove('hidden');
                document.getElementById('admin-stats').classList.remove('hidden');
                const pending = (DATA.allRequests || []).filter(r => r.status === 'Pending').length;
                if (pending > 0) {
                    document.getElementById('badge-pending').textContent = pending;
                    document.getElementById('badge-pending').classList.remove('hidden');
                }
            } else {
                document.getElementById('menu-emp').classList.remove('hidden');
                document.getElementById('balance-badge').classList.remove('hidden');
            }
            
            renderDashboard();
            initCalendar();
            nav('home');
        }

        function nav(id) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            
            if (id === 'new-req' && calendarObj) setTimeout(() => calendarObj.updateSize(), 200);
            if (id === 'my-req') renderMyRequests();
            if (id === 'admin-req') renderAdminRequests();
            if (id === 'employees') loadEmployees();
            if (id === 'settings') renderSettings();
        }

        function renderDashboard() {
            const all = DATA.allRequests || [];
            document.getElementById('st-total').textContent = all.length;
            document.getElementById('st-pending').textContent = all.filter(r => r.status === 'Pending').length;
            document.getElementById('st-approved').textContent = all.filter(r => r.status === 'Approved').length;
            document.getElementById('st-rejected').textContent = all.filter(r => r.status === 'Rejected').length;

            const today = new Date().toISOString().split('T')[0];
            const out = (DATA.teamLeaves || []).filter(l => today >= l.start && today <= l.end);
            const container = document.getElementById('team-view-container');
            
            if (out.length === 0) {
                container.innerHTML = '<span class="badge bg-success bg-opacity-10 text-success px-3 py-2"><i class="fas fa-check-circle me-2"></i>All Present Today</span>';
            } else {
                container.innerHTML = out.map(o => `
                    <div class="d-flex align-items-center bg-light rounded p-2 border">
                        <div class="bg-primary text-white rounded-circle d-flex me-2" style="width:35px;height:35px;align-items:center;justify-content:center;font-weight:600">
                            ${o.name.charAt(0)}
                        </div>
                        <div style="line-height:1.2">
                            <div class="fw-bold small">${o.name}</div>
                            <small class="text-muted" style="font-size:10px">${o.type} - Until ${o.end}</small>
                        </div>
                    </div>
                `).join('');
            }
        }

        function initCalendar() {
            const el = document.getElementById('calendar');
            if (!el) return;
            
            calendarObj = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth',
                height: 550,
                headerToolbar: { 
                    left: 'prev,next', 
                    center: 'title', 
                    right: 'today' 
                },
                dateClick: (info) => {
                    const today = new Date().toISOString().split('T')[0];
                    if (info.dateStr < today) {
                        return Swal.fire('Past Date', 'Cannot request leave for past dates', 'warning');
                    }
                    
                    const limit = getDailyLimit(info.dateStr);
                    const count = getApprovedCount(info.dateStr);
                    
                    if (limit === 0 || count >= limit) {
                        return Swal.fire('Fully Booked', 'This date has reached its limit', 'error');
                    }
                    
                    openReqModal(info.dateStr);
                },
                dayCellClassNames: (arg) => {
                    const d = arg.date.toISOString().split('T')[0];
                    const today = new Date().toISOString().split('T')[0];
                    
                    if (d < today) return ['day-past'];
                    
                    const lim = getDailyLimit(d);
                    const cnt = getApprovedCount(d);
                    
                    if (lim === 0 || cnt >= lim) return ['day-blocked'];
                    if (cnt >= lim - 1) return ['day-limited'];
                    
                    return [];
                }
            });
            
            calendarObj.render();
        }

        function getDailyLimit(d) {
            const sea = (DATA.settings || []).filter(s => s.type === 'Season');
            for (let rule of sea) {
                if (d >= rule.start && d <= rule.end) return rule.limit;
            }
            const def = (DATA.settings || []).find(s => s.type === 'Default');
            return def ? def.limit : 2;
        }

        function getApprovedCount(d) {
            return (DATA.approvedRequests || []).filter(r => d >= r.start && d <= r.end).length;
        }

        function openReqModal(date) {
            try {
                document.getElementById('m-start').value = date;
                document.getElementById('m-end').value = date;
                document.getElementById('m-duration').value = 'Full';
                document.getElementById('m-type').value = 'Annual';
                document.getElementById('m-notes').value = '';
                document.getElementById('m-file').value = '';
                document.getElementById('req-bal').textContent = DATA.user ? DATA.user.balance : 0;
                calcDays();
                new bootstrap.Modal(document.getElementById('reqModal')).show();
            } catch(e) { 
                Swal.fire('Error', 'Could not open form: ' + e.message, 'error'); 
            }
        }

        function calcDays() {
            const s = document.getElementById('m-start').value;
            const e = document.getElementById('m-end').value;
            const dur = document.getElementById('m-duration').value;
            
            if (dur === 'Half') {
                document.getElementById('m-end').value = s;
                document.getElementById('req-days').textContent = "0.5";
            } else if (s && e) {
                const d1 = new Date(s);
                const d2 = new Date(e);
                const diff = Math.abs(d2 - d1);
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('req-days').textContent = days;
            }
        }

        async function sendReq() {
            const form = {
                username: DATA.user.username,
                name: DATA.user.name,
                start: document.getElementById('m-start').value,
                end: document.getElementById('m-end').value,
                days: parseFloat(document.getElementById('req-days').textContent),
                type: document.getElementById('m-type').value,
                notes: document.getElementById('m-notes').value
            };
            
            const fileInput = document.getElementById('m-file');
            let fileData = null;
            
            // Validation
            if (new Date(form.end) < new Date(form.start)) {
                return Swal.fire('Invalid Dates', 'End date must be after or equal to start date', 'error');
            }
            
            // File handling
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if (file.size > maxSize) {
                    return Swal.fire('File Too Large', 'Maximum file size is 5MB', 'error');
                }
                
                try {
                    fileData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({
                            name: file.name,
                            type: file.type,
                            data: e.target.result
                        });
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                } catch (e) {
                    return Swal.fire('File Error', 'Could not read file', 'error');
                }
            }
            
            submitData(form, fileData);
        }

        async function submitData(form, fileData) {
            showLoading('Submitting request...');
            bootstrap.Modal.getInstance(document.getElementById('reqModal')).hide();
            
            try {
                const res = await apiCall({ 
                    action: 'submitRequest', 
                    form: form, 
                    fileData: fileData 
                });
                
                if (res.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Request Submitted!',
                        text: res.message,
                        timer: 2000
                    });
                    await refreshData();
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Failed to submit request', 'error');
            }
            
            hideLoading();
        }

        function renderMyRequests() {
            const tbody = document.getElementById('tb-my-req');
            const reqs = DATA.myRequests || [];
            
            if (reqs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No requests yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = reqs.map(r => `
                <tr>
                    <td>${r.timestamp || 'N/A'}</td>
                    <td><span class="badge bg-secondary">${r.type}</span></td>
                    <td>${r.start} â†’ ${r.end}</td>
                    <td><strong>${r.days || 1}</strong></td>
                    <td><span class="badge-status bg-${r.status.toLowerCase()}">${r.status}</span></td>
                    <td><small>${r.notes || 'â€”'}</small></td>
                    <td>
                        ${r.attachment ? 
                            `<a href="${r.attachment}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file-pdf"></i>
                            </a>` 
                            : 'â€”'}
                    </td>
                </tr>
            `).join('');
        }

        function renderAdminRequests() {
            const tbody = document.getElementById('tb-admin-req');
            const reqs = DATA.allRequests || [];
            
            if (reqs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No requests</td></tr>';
                return;
            }
            
            tbody.innerHTML = reqs.map(r => `
                <tr>
                    <td>
                        <strong>${r.name}</strong><br>
                        <small class="text-muted">${r.username}</small>
                    </td>
                    <td><span class="badge bg-secondary">${r.type}</span></td>
                    <td>${r.start}<br><small class="text-muted">${r.end}</small></td>
                    <td><strong>${r.days || 1}</strong></td>
                    <td><span class="badge-status bg-${r.status.toLowerCase()}">${r.status}</span></td>
                    <td>
                        ${r.attachment ? 
                            `<a href="${r.attachment}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file"></i>
                            </a>` 
                            : 'â€”'}
                    </td>
                    <td>
                        ${r.status === 'Pending' ? 
                            `<button onclick="adminAct('${r.id}','Approved')" class="btn btn-sm btn-success">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="adminAct('${r.id}','Rejected')" class="btn btn-sm btn-danger">
                                <i class="fas fa-times"></i>
                            </button>` 
                            : '<span class="text-muted">â€”</span>'}
                    </td>
                </tr>
            `).join('');
        }

        async function adminAct(id, act) {
            const result = await Swal.fire({
                title: `${act} this request?`,
                text: 'This action will be recorded',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            });
            
            if (!result.isConfirmed) return;
            
            showLoading('Processing...');
            try {
                const res = await apiCall({ action: 'adminAction', id: id, act: act, notes: '' });
                if (res.success) {
                    Swal.fire('Success', res.message, 'success');
                    await refreshData();
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Failed to process', 'error');
            }
            hideLoading();
        }

        async function loadEmployees() {
            const tb = document.getElementById('tb-employees');
            tb.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';
            
            try {
                const res = await apiCall({ action: 'getAllEmployees' });
                if (res.success && res.employees) {
                    tb.innerHTML = res.employees.map(e => `
                        <tr>
                            <td>${e.name}</td>
                            <td>${e.username}</td>
                            <td><span class="badge bg-primary">${e.role}</span></td>
                            <td>${e.email}</td>
                            <td><strong>${e.balance}</strong> days</td>
                            <td>
                                <button onclick="openBalModal('${e.username}', ${e.balance})" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit"></i> Edit Balance
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tb.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No employees</td></tr>';
                }
            } catch (e) {
                tb.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading</td></tr>';
            }
        }

        function openAddEmpModal() {
            document.getElementById('e-name').value = '';
            document.getElementById('e-user').value = '';
            document.getElementById('e-pass').value = '';
            document.getElementById('e-mail').value = '';
            document.getElementById('e-role').value = 'Employee';
            document.getElementById('e-bal').value = '20';
            new bootstrap.Modal(document.getElementById('empModal')).show();
        }

        async function addEmployee() {
            const emp = {
                name: document.getElementById('e-name').value.trim(),
                username: document.getElementById('e-user').value.trim(),
                password: document.getElementById('e-pass').value,
                email: document.getElementById('e-mail').value.trim(),
                role: document.getElementById('e-role').value,
                balance: document.getElementById('e-bal').value
            };
            
            if (!emp.name || !emp.username || !emp.password || !emp.email) {
                return Swal.fire('Missing Fields', 'Please fill all required fields', 'error');
            }
            
            showLoading('Adding employee...');
            bootstrap.Modal.getInstance(document.getElementById('empModal')).hide();
            
            try {
                const res = await apiCall({ action: 'addEmployee', employee: emp });
                if (res.success) {
                    Swal.fire('Success', 'Employee added successfully', 'success');
                    await loadEmployees();
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Failed to add employee', 'error');
            }
            
            hideLoading();
        }

        function openBalModal(u, b) {
            document.getElementById('eb-user').value = u;
            document.getElementById('eb-val').value = b;
            new bootstrap.Modal(document.getElementById('balModal')).show();
        }

        async function saveBalance() {
            const username = document.getElementById('eb-user').value;
            const newBalance = document.getElementById('eb-val').value;
            
            showLoading('Updating balance...');
            bootstrap.Modal.getInstance(document.getElementById('balModal')).hide();
            
            try {
                const res = await apiCall({ 
                    action: 'updateBalance', 
                    username: username, 
                    balance: newBalance 
                });
                
                if (res.success) {
                    Swal.fire('Success', 'Balance updated', 'success');
                    await loadEmployees();
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Failed to update', 'error');
            }
            
            hideLoading();
        }

        function openChangePassword() {
            document.getElementById('old-pass').value = '';
            document.getElementById('new-pass').value = '';
            document.getElementById('confirm-pass').value = '';
            new bootstrap.Modal(document.getElementById('passModal')).show();
        }

        async function changePassword() {
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;
            const confirmPass = document.getElementById('confirm-pass').value;
            
            if (!oldPass || !newPass || !confirmPass) {
                return Swal.fire('Missing Fields', 'All fields are required', 'error');
            }
            
            if (newPass !== confirmPass) {
                return Swal.fire('Mismatch', 'New passwords do not match', 'error');
            }
            
            if (newPass.length < 4) {
                return Swal.fire('Too Short', 'Password must be at least 4 characters', 'error');
            }
            
            showLoading('Changing password...');
            bootstrap.Modal.getInstance(document.getElementById('passModal')).hide();
            
            try {
                const res = await apiCall({
                    action: 'changePassword',
                    username: DATA.user.username,
                    oldPass: oldPass,
                    newPass: newPass
                });
                
                if (res.success) {
                    Swal.fire('Success', 'Password changed successfully', 'success');
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Failed to change password', 'error');
            }
            
            hideLoading();
        }

        function renderSettings() {
            const seasons = (DATA.settings || []).filter(x => x.type === 'Season');
            const tbody = document.getElementById('tb-settings');
            
            // Update current default limit display
            const defaultSetting = (DATA.settings || []).find(x => x.type === 'Default');
            if (defaultSetting) {
                document.getElementById('current-default').textContent = defaultSetting.limit;
                document.getElementById('default-limit').value = defaultSetting.limit;
            } else {
                document.getElementById('current-default').textContent = '2 (default)';
                document.getElementById('default-limit').value = '2';
            }
            
            if (seasons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No seasonal rules defined</td></tr>';
                return;
            }
            
            tbody.innerHTML = seasons.map((x, i) => `
                <tr>
                    <td>${x.start}</td>
                    <td>${x.end}</td>
                    <td><strong>${x.limit}</strong> ${x.limit === 0 ? '(Blocked)' : ''}</td>
                    <td>
                        <button onclick="delSet(${i})" class="btn btn-sm btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function updateDefaultLimit() {
            const newLimit = document.getElementById('default-limit').value;
            
            if (newLimit === '' || newLimit < 0) {
                return Swal.fire('Invalid Value', 'Please enter a valid number (0 or greater)', 'error');
            }
            
            showLoading('Updating default limit...');
            
            try {
                const res = await apiCall({
                    action: 'updateDefaultLimit',
                    limit: parseInt(newLimit)
                });
                
                if (res.success) {
                    await refreshData();
                    renderSettings();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Updated!',
                        text: `Default limit set to ${newLimit}`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Failed to update', 'error');
            }
            
            hideLoading();
        }

        async function saveSeason() {
            const start = document.getElementById('s-start').value;
            const end = document.getElementById('s-end').value;
            const limit = document.getElementById('s-limit').value;
            
            if (!start || !end || limit === '') {
                return Swal.fire('Missing Fields', 'All fields are required', 'error');
            }
            
            showLoading('Saving rule...');
            
            try {
                await apiCall({ 
                    action: 'saveSeason', 
                    start: start, 
                    end: end, 
                    limit: limit 
                });
                
                Swal.fire('Success', 'Rule added', 'success');
                document.getElementById('s-start').value = '';
                document.getElementById('s-end').value = '';
                document.getElementById('s-limit').value = '';
                await refreshData();
                renderSettings(); // ðŸ”´ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
            } catch (e) {
                Swal.fire('Error', 'Failed to save', 'error');
            }
            
            hideLoading();
        }

        async function delSet(i) {
            const result = await Swal.fire({
                title: 'Delete this rule?',
                text: 'This action cannot be undone',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                confirmButtonColor: '#ef4444'
            });
            
            if (!result.isConfirmed) return;
            
            showLoading('Deleting...');
            
            try {
                await apiCall({ action: 'deleteSetting', index: i });
                Swal.fire('Deleted', 'Rule removed', 'success');
                await refreshData();
                renderSettings(); // ðŸ”´ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
            } catch (e) {
                Swal.fire('Error', 'Failed to delete', 'error');
            }
            
            hideLoading();
        }

        async function refreshData() {
            try {
                const res = await apiCall({ 
                    action: 'login', 
                    username: DATA.user.username, 
                    password: 'refresh' 
                });
                
                if (res.success) {
                    DATA = res;
                    DATA.settings = DATA.settings || [];
                    DATA.approvedRequests = DATA.approvedRequests || [];
                    DATA.teamLeaves = DATA.teamLeaves || [];
                    
                    // Update UI
                    if (DATA.user.role === 'Admin') {
                        renderDashboard();
                        const pending = (DATA.allRequests || []).filter(r => r.status === 'Pending').length;
                        document.getElementById('badge-pending').textContent = pending;
                        if (pending > 0) {
                            document.getElementById('badge-pending').classList.remove('hidden');
                        } else {
                            document.getElementById('badge-pending').classList.add('hidden');
                        }
                    } else {
                        document.getElementById('u-balance').textContent = DATA.user.balance;
                        document.getElementById('disp-balance').textContent = DATA.user.balance;
                        renderDashboard();
                    }
                    
                    if (calendarObj) {
                        calendarObj.refetchEvents();
                        calendarObj.render();
                    }
                    
                    // ðŸ”´ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØµÙØ­Ø© SettingsØŒ Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    const currentPage = document.querySelector('.page-section:not(.hidden)');
                    if (currentPage && currentPage.id === 'page-settings') {
                        renderSettings();
                    }
                }
            } catch (e) {
                console.error('Refresh failed:', e);
            }
        }
    </script>
</body>
</html>
